NavPanel = (function( sendApiRequest, $ )
{
	var dummy_session_timeout = null;

	function init()
	{

		initConsole();
	}

	function initConsole()
	{
		var command_n = 0;

		$( '#console').terminal(function(command, term)
			{
				var my_command_n = command_n++;
				var id = 'term_resp_' + my_command_n;
				var result = '<div id="' + id + '"><i class="fa fa-spin fa-circle-o-notch"></i></div>';
				var inner_fn = function(){ return result };
				var fn = function(){ return inner_fn() };
				term.pause();
				if( $d( 'Debugger', 'sessionIsActive' ) )
				{
					term.echo( fn, { raw : true } );

					// After scouring the Xdebug protocol docs for a way to get a variable name from an
					// address, which would be required to lazy-load the response's object/array's nested
					// properties, I came up empty-handed. Lazy-loading doesn't seem to be a viable option
					// here, so let's deep-load the response instead
					$d( 'Debugger', 'command', 'feature_set', { name : 'max_depth', value : 10 } );
					$d( 'Debugger', 'command', 'eval', function( data )
					{
						if ( data.parsed.value && data.parsed.value.length )
						{
							data.parsed.value.forEach( function( item )
							{
								item.name     = item.name || '';
								item.fullname = item.fullname || '';
							} );
							$( '#' + id ).html( '' ).jstree( { core : { data : StatusPanel.buildContextTree( data.parsed.value ) } } );
							inner_fn = function()
							{ 
								setTimeout( function(){ $( '#' + id ).html( '' ).jstree( { core : { data : StatusPanel.buildContextTree( data.parsed.value ) } } ); }, 30 );
								return result;
							};
						}
						else if ( data.parsed.message )
						{
							var message = $( '<div>' ).text( data.parsed.message ).html();
							message = '<span class="debugger-message">' + message + '</span>';
							$( '#' + id ).html( message );
						}
						else
						{
							$( '#' + id ).html( '<span class="no-debugger-message">Empty response '
								+ 'received</span>' );
						}
					}, command );
					$d( 'Debugger', 'command', 'feature_set', { name : 'max_depth', value : 1 } );
				}
				else
				{
					term.echo( 'No session is currently active. Just want to tinker? <a class="start-dummy-session" href="#">Start a dummy session</a>', { raw : true } );
				}
				term.resume();
		},
		{
			greetings: '[[b;#21599f;]DPOH PHP Console]\nTo use this console, a debugging session must be active\n',
			prompt : 'php> ',
		} );
		var lowercase = [
		'__halt_compiler', 'abstract', 'and', 'array', 'as', 'break', 'callable', 'case', 'catch', 'class', 'clone', 'const', 'continue', 'declare', 'default', 'die', 'do', 'echo', 'else', 'elseif', 'empty', 'enddeclare', 'endfor', 'endforeach', 'endif', 'endswitch', 'endwhile', 'eval', 'exit', 'extends', 'final', 'for', 'foreach', 'function', 'global', 'goto', 'if', 'implements', 'include', 'include_once', 'instanceof', 'insteadof', 'interface', 'isset', 'list', 'namespace', 'new', 'or', 'print', 'private', 'protected', 'public', 'require', 'require_once', 'return', 'static', 'switch', 'throw', 'trait', 'try', 'unset', 'use', 'var', 'while', 'xor'
	];
	var keywords = lowercase.concat(lowercase.map(function(keyword) {
    	return keyword.toUpperCase();
	}));
	$.terminal.defaults.formatters.push(function(string) {
    	return string.split(/((?:\s|&nbsp;)+)/).map(function(string) {
        	if (keywords.indexOf(string) != -1) {
            	return '[[;#268bd2;]' + string + ']';
        	} else if ( string[ 0 ] == '$' && string.length > 1) {
            	return '[[;#59c203;]' + string + ']';
        	} else {
            	return string;
        	}
    	}).join('');
	});
	}

	function onDocumentClick( e )
	{
		if ( !$( e.target ).closest( '.showing, [data-open-nav-panel]' ).length )
		{
			$( '.showing' ).removeClass( 'showing' );
		}
	}

	function onLoading( a, b, c ,d )
	{
		console.log( arguments );
	}

	function onNavButtonClicked( e )
	{
		var selector = $( e.currentTarget ).attr( 'data-open-nav-panel' );
		if ( selector == '#console' )
		{
			$( '#console .input' ).focus();
		}
		$( selector ).addClass( 'showing' );
		
	}
	
	function sortBreakpointList( breakpoints )
	{
		var sorted = {
			Files      : {},
			Functions  : {},
		};
		
		var process_line_bp = function( bp )
		{
			if ( !sorted.Files[ bp.filename ] )
			{
				sorted.Files[ bp.filename ] = [];
			}
			sorted.Files[ bp.filename ].push( bp )
		};
		breakpoints.line.forEach( process_line_bp );
		breakpoints.conditional.forEach( process_line_bp );
		
		var sort_file_bp = function( bp1, bp2 )
		{
			return ( bp1.lineno || Math.NEGATIVE_INFINITY ) - ( bp2.lineno || Math.NEGATIVE_INFINITY );
		};
		for ( var i in sorted.Files )
		{
			sorted.Files[ i ] = sorted.Files[ i ].sort( sort_file_bp );
		}
		
		var process_fn_bp = function( bp )
		{
			if ( !sorted.Functions[ bp[ 'function' ] ] )
			{
				sorted.Functions[ bp[ 'function' ] ] = [];
			}
			sorted.Functions[ bp[ 'function' ] ].push( bp );
		};
		breakpoints.call.forEach( process_fn_bp );
		breakpoints[ 'return' ].forEach( process_fn_bp );
		
		var sort_fn_bp = function( bp1, bp2 )
		{
			return ( bp1.type == 'call' ? 1 : 0 ) - ( bp2.type == 'call' ? 1 : 0 );
		};
		for ( var i in sorted.Functions )
		{
			sorted.Functions[ i ] = sorted.Functions[ i ].sort( sort_fn_bp );
		}
		
		return sorted;
	}

	function onOpenFileClicked( e )
	{
		var file = $( e.currentTarget ).attr( 'data-file' );
		$( document ).trigger( {
			type     : 'dpoh-interface:file-nav-request',
			filename : file,
			source   : 'file-nav',
		} );
		$( '#open_files_panel .open-file' ).removeClass( 'active' );
		$( e.currentTarget ).addClass( 'active' );
		$( '.nav-panel.showing' ).removeClass( 'showing' );
	}

	function getShortFileName( filename )
	{
		return filename.replace( /^.*\//, '' );
	}

	function onNodeDoubleClicked( e, data )
	{
		var li = $( e.target ).closest( 'li' );
		var is_file = li.attr( 'data-is-file' );
		if ( !is_file || is_file === "false" )
		{
			return;
		}

		$( '.nav-panel.showing' ).removeClass( 'showing' );
		var filename = li.attr( 'data-full-path' );
		$( document ).trigger( {
			type     : 'dpoh-interface:file-nav-request',
			filename : filename,
			source   : 'tree',
		} );
	}

	function onDocumentKeydown( e )
	{
		var target = $( e.target );
		if ( e.which == 'O'.charCodeAt(0) && e.ctrlKey )
		{
			e.preventDefault();
			$( '.showing' ).removeClass( 'showing' );
			$( '#open_files_panel' ).addClass( 'showing' );
		}
		else if ( e.which == 'E'.charCodeAt( 0 ) && e.ctrlKey )
		{
			e.preventDefault();
			$( '.showing' ).removeClass( 'showing' );
			$( '#console' ).addClass( 'showing' );
			$( '#console .input' ).focus();
		}
		else if ( e.which == 27 )
		{
			$( '.showing' ).removeClass( 'showing' );
		}
	}

	function resizeCell()
	{
		var height = $( '.toolbar .css-cell:not(.match-height)' ).height();
		$( '.toolbar .css-cell.match-height' ).height( height + 1 );
	}

	function onFileChanged( e )
	{
		$( '.files-heading' ).slideDown();
		var filename_only = e.file.replace( /^.*\//, '' );
		if ( !$( '[data-open-file="' + e.file + '"]', '.currently-open-files' ).length )
		{
			var new_button = $( '<span>' ).attr( 'data-open-file', e.file )
				.text( filename_only );
			$( '.currently-open-files' ).append( new_button );
		}

		$( '.currently-open' ).removeClass( 'currently-open' );
		$( '[data-open-file="' + e.file + '"]', '.currently-open-files' ).addClass( 'currently-open' );
	}

	function onOpenFileClicked( e )
	{
		$( document ).trigger( {
			type     : 'dpoh-interface:file-nav-request',
			filename : $( e.target ).attr( 'data-open-file' ),
			source   : 'currently-open-files',
		} );
	}

	function onStartDummySessionClicked( e )
	{
		if ( !$d( 'Debugger', 'sessionIsActive' ) )
		{
			e.preventDefault();
			clearInterval( dummy_session_timeout );
			dummy_session_timeout = setInterval( function()
			{
				$.get( 'dummy.php?XDEBUG_SESSION_START' );
			}, 250 );
		}
	}

	function onSessionStatusChanged()
	{
		clearInterval( dummy_session_timeout );
	}

	$( init );

	$( document ).on( 'dblclick.jstree',   '#open_files_panel',  onNodeDoubleClicked );
	$( document ).on( 'loading.jstree',    '#breakpoints_panel', onLoading );
	$( document ).on( 'keydown',                                 onDocumentKeydown );
	$( document ).on( 'click',                                   onDocumentClick );
	$( document ).on( 'click', '.start-dummy-session',           onStartDummySessionClicked );
	$( document ).on( 'dpoh:session-status-changed', onSessionStatusChanged );
	$( document ).on( 'click', '[data-open-nav-panel]',          onNavButtonClicked );
	$( document ).on( 'click', '[data-open-file]',               onOpenFileClicked );
	$( window   ).on( 'resize load',                             resizeCell );
	$( document ).on( 'dpoh-interface:file-changed',             onFileChanged );
	$( document ).on( 'click',             '[data-open-file]',   onOpenFileClicked );

}( send_api_request, jQuery ));
