#!/usr/bin/env php
<?php

function generate_docker_compose_file( array $options )
{
	$timestamp = date( 'Y-m-d g:i A' );
	$my_name   = __FILE__;
	return <<<EOF
# FILE AUTOMATICALLY GENERATED BY $my_name AT $timestamp. MODIFICATIONS MAY BE LOST.
version: '2.4'
services:
  web:
    build:
      context: ./web
    ports:
      - $options[web_port]:80
    volumes:
      - ..:/var/www/html
$options[volumes]

  socket_server:
    build:
      context: ./socket_server
    command: ["/var/www/html/vcli", "socket-server:start"]
    working_dir: /var/www/html/
    stop_grace_period: 1s
    ports:
      - $options[websocket_port]:3001
      - $options[debug_port]:9000
    volumes:
      - ..:/var/www/html
$options[volumes]
EOF;
}

function check_for_requirements()
{
	$missing_any = FALSE;
	echo "Checking for docker and docker-compose:\n";

	exec( 'which docker', $_, $status );
	echo " - docker: " . ( !$status ? 'OK' : 'FAIL' ) . "\n";
	$missing_any = !$status;

	exec( 'which docker-compose', $_, $status );
	echo " - docker-compose: " . ( !$status ? 'OK' : 'FAIL' ) . "\n";
	return $missing_any && !$status;
}

check_for_requirements();

$options[ 'web_port' ]       = 3008;
$options[ 'debug_port' ]     = 9000;
$options[ 'websocket_port' ] = 3005;
$options[ 'volumes' ]        = '      - /srv:/srv';

file_put_contents( 'docker-compose.yml', generate_docker_compose_file( $options ) );
